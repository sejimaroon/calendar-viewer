<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

  <style>
    body { margin: 0; padding: 20px; font-family: sans-serif; }
    #calendar { max-width: 900px; margin: 0 auto; }
    #timeslots, #reservationForm {
      max-width: 600px;
      margin: 20px auto;
      padding: 10px;
      border: 1px solid #ccc;
    }
    button { margin: 5px; padding: 5px 10px; }
    input, textarea { width: 100%; margin-bottom: 10px; }
  </style>
</head>

<body>
  <div id="calendar"></div>
  <div id="timeslots"></div>

  <div id="reservationForm" style="display:none;">
    <h3>予約フォーム</h3>
    <p id="selectedTime"></p>
    <input type="text" id="name" placeholder="お名前">
    <input type="email" id="email" placeholder="メールアドレス">
    <textarea id="content" placeholder="診療内容"></textarea>
    <button onclick="submitReservation()">予約する</button>
  </div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbxo7hxy6d4DhMFuhBww-xb9unFnWd8GwS13l66DKyigTF_GDe01c5UDwVrURgwT1xqSXw/exec";

document.addEventListener("DOMContentLoaded", function () {
  const calendarEl = document.getElementById("calendar");

  const calendar = new FullCalendar.Calendar(calendarEl, {
    timeZone: "Asia/Tokyo",
    locale: "ja",
    initialView: "dayGridMonth",
    height: "auto",
    headerToolbar: {
      left: "prev,next today",
      center: "title",
      right: ""
    },
    events: function(info, success, failure) {
      fetch(`${GAS_URL}?function=getEvents`)
        .then(res => res.json())
        .then(data => success(data))
        .catch(err => failure(err));
    },
    dateClick: function(info) {
      const dateStr = info.dateStr;
      const box = document.getElementById("timeslots");
      box.innerHTML = `<strong>${dateStr} の空き時間</strong><br>`;

      fetch(`${GAS_URL}?function=getEvents`)
        .then(res => res.json())
        .then(events => {
          const slots = events.filter(e => e.start.startsWith(dateStr));
          if (slots.length === 0) {
            box.innerHTML += "空きなし";
            return;
          }

          box.innerHTML += slots.map(s => {
            const time = s.start.slice(11, 16);
            return `<button onclick="selectSlot('${s.start}')">${time}</button>`;
          }).join("");
        });
    }
  });

  calendar.render();
});

function selectSlot(datetime) {
  document.getElementById("reservationForm").style.display = "block";
  document.getElementById("selectedTime").textContent = `選択中：${datetime.replace("T", " ")}`;
  document.getElementById("reservationForm").dataset.datetime = datetime;
}

function submitReservation() {
  const name = document.getElementById("name").value;
  const email = document.getElementById("email").value;
  const content = document.getElementById("content").value;
  const datetime = document.getElementById("reservationForm").dataset.datetime;

  if (!name || !email || !datetime) {
    alert("必須項目を入力してください");
    return;
  }

  fetch(GAS_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ name, email, content, datetime })
  })
  .then(res => res.json())
  .then(() => {
    alert("予約完了");
    location.reload();
  });
}
</script>
</body>
</html>
